{% extends 'layout.html' %}
{% block title%}
    Bless Library
{% endblock %}

{% block background %}

<div class='bg bg-bless'>

    {%endblock%}
    {% block content %}
    <div class="input-container">
            <h1>Bless Blocks</h1>
            <p>Manage your blessings and create new ones.</p>
    </div>

    <button id='preset-btn' class='btn-width button-page'>Preset Blocks</button>
    <button id='custom-btn' class='btn-width button-page'>Custom Blocks</button>


    <!-- Modal preview modal -->
    <div id="modalPreview" class="modal fade" role="dialog">
        <div class="modal-dialog">


            <!-- Scrollable modal -->
            <div class="modal-content model-custom">
                <div class="modal-header">
                    <h4 id="title" class="modal-title">Bless Title</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="tab text-field">
                    <pre id='heb' class="hebrew" style="direction:rtl"></pre>
                </div>
                <div class="tab text-field">
                    <pre id="eng" class="english"></pre>
                </div>
                <div class="tab text-field"> <pre id="eng-heb" class="english">words</pre></div>
                <div class="tab text-field"> <pre id="meaning" class="english">words</pre></div>
                <div class='button-placement'>
                    <button id='back' type="button" class="nextprev prev">Back</button>
                    <button id='delete' type='button' style='display:none' class="nextprev delete" data-dismiss="modal">Delete</button>
                    <button id='next' type="button" class="nextprev next">Next</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>

    </div>


    <!-- Modal create modal -->
    <div id="modalCreate" class="modal fade" role="dialog">
        <div class="modal-dialog">


            <!-- Scrollable modal -->
            <div class="modal-content model-custom">
                <div class="modal-header">
                    <h4 id="title-create" class="modal-title">Create New Bless Block</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="tab2">
                    <input class="input-small" id='title-block' placeholder="title">
                </div>
                <div class="tab2">
                    <textarea id='heb-create' style="direction:rtl" class="hebrew text-field" placeholder="עברית"></textarea>
                </div>
                <div class="tab2">
                    <textarea id="eng-create" class="english text-field" placeholder="translation"></textarea>
                </div>
                <div class="tab2"> <textarea id="eng-heb-create" class="english text-field" placeholder="transliteration"></textarea></div>
                <div class="tab2"> <textarea id="meaning-create" class="english text-field" placeholder="meaning"></textarea></div>
                <div class='button-placement'>
                    <button id='back-create' type="button" class="nextprev prev">Back</button>
                    
                    <button id='next-create' type="button" class="nextprev next">Next</button>

                    <button id='create-create' type="button" class="nextprev next">Create</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>

    </div>



    <div>
        <div id="preset">
        <ul class='list' id='preset'>
            {% for bless in genBless %}
            <li>
                <div bless-value='{{ bless.id }}' class="bless bless_normal" data-toggle="modal" data-target="#modalPreview">  
                    <marquee behavior="scroll" scrollamount=“-15” direction="left" class="bless_title">{{ bless.bless_name }}</marquee>
                </div>
            </li>
            {% endfor %}
            <p class='source join_text'>All Preset Block blessing information is sourced from <a href="https://www.myjewishlearning.com/article/shabbat-blessings/">myjewishlearning.com</a>.</p>
        </ul>
        </div>
            <div id="custom" style="display:none">
                <ul class='list'>
                    {% for bless in userBless %}
                    <li>
                    <div bless-value='{{ bless.id }}' class="bless bless_normal custom_bless" data-toggle="modal" data-target="#modalPreview">  
                        <h2 class="bless_title">{{ bless.bless_name }}</h2>
                    </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </ul>
    </div>

    <div id="bless_create_new">
        <button id='create-btn' class='button-page' data-toggle="modal" data-target="#modalCreate">Create Bless Block</button>
    </div>
</div>

<script>
// Multistep form functionality referenced from w3schools.com
// URL: https://www.w3schools.com/howto/howto_js_form_steps.asp

    // preview bless blocks
    $(document).ready(function () {
        $('.bless').on('click', function() {
            $('.tab').hide();
            let currentTab = 0;
        

            currentTab = 0;

            

            showTab(currentTab);

            function showTab(n) {
                let x = $('.tab');

                $('.tab:eq('+currentTab+')').show();

                console.log("this is show tab " + currentTab)

                if (n == 0) {
                    $("#back").hide();
                } else {
                    $('#back').show();
                }

                if (n == (x.length - 1)) {
                    $("#next").hide();
                } else {
                    $('#next').show();
                }
            }

            $('#next').on('click', function() {
                nextPrevClick(1);
                $('.tab').hide();
                showTab(currentTab);
                console.log("this is" + currentTab)      
            })

            $('#back').on('click', function() {
                nextPrevClick(-1);
                $('.tab').hide();
                showTab(currentTab);     
            })

            function nextPrevClick(n) {
            
                $('.tab:eq('+currentTab+')').hide();

                currentTab = currentTab + n;

                console.log(currentTab)

            }
        })

    })

    // create bless blocks
    $(document).ready(function () {
        
        $('#create-btn').on('click', function() {
            $('#create-create').unbind('click');
            $('#next-create').unbind('click');
            $('#back-create').unbind('click');

            console.log(currentTab_create)
            function nextPrevClick(n, currentTab) {
            
                let x = $('.tab2');

                if (n == 1 && !validateForm()) {
                    return false;
                    
                }

                console.log($('#next-create').val())

                $('.tab2:eq('+currentTab_create+')').hide();

                currentTab_create += n;

                console.log(currentTab_create)

            }

            $('.tab2').hide();
            
            var currentTab_create = 0;

            showTab(currentTab_create);

            function showTab(n) {
                let x = $('.tab2');

                $('.tab2:eq('+currentTab_create+')').show();

                if (n == 0) {
                    $("#back-create").hide();
                } else {
                    $('#back-create').show();
                }

                if (n == (x.length - 1)) {
                    $("#next-create").hide()
                    $("#create-create").show()
             
                } else {
                    $('#next-create').show()
                    $('#create-create').hide()
                }
            }

            $('#next-create').on('click', function() {
                let x = 1;
                nextPrevClick(x);
                $('.tab2').hide();
                showTab(currentTab_create);
            })

            $('#back-create').on('click', function() {
                let x = -1;
                nextPrevClick(x);
                $('.tab2').hide();
                showTab(currentTab_create);     
            })

            $('#create-create').on('click', function () {
                x = 1
                nextPrevClick(x)

                if ($('#meaning-create').val() != "") {
                    let blessdict = {
                        bname : $("#title-block").val(),
                        bheb : $("#heb-create").val(),
                        beng : $("#eng-create").val(),
                        beng_heb : $("#eng-heb-create").val(),
                        bmeaning : $("#meaning-create").val()
                    }

                    let js_data = JSON.stringify(blessdict)

                    $.ajax({
                        url : "/_create_bless",
                        type : 'post',
                        contentType : "application/json",
                        dataType : 'json',
                        data: js_data,
                        success: function (data) {
                            console.log(data.id);
                            location.reload();
                        }
                    })
                    

                    return false;

                }

            })

            function validateForm() {
                // By default valid is true
                let x, y, z, valid = true;
                
                // x is all elements by class tab, y is all elements by class input
                // in current tab
                x = document.getElementsByClassName('tab2');
                y = x[currentTab_create].getElementsByTagName('input');
                z = x[currentTab_create].getElementsByTagName('textarea')

                // While i is less than the length of the inputs
                for (let i = 0; i < y.length; i++) {

                    // If the ith input is nothing
                    if (y[i].value == "") {
                        // if not already class invalid
                        if (y[i].className != " invalid-box") {
                            // add class invalid
                            y[i].className += " invalid-box";
                        }
                        // Change valid to false
                        valid = false;
                        
                    }

                    if (y[i].value != "") {
                        y[i].classList.remove('invalid-box')

                    }
                }

                // While i is less than the length of the inputs
                for (let i = 0; i < z.length; i++) {

                    // If the ith input is nothing
                    if (z[i].value == "") {
                        // if not already class invalid
                        if (z[i].className != "invalid-box") {
                            // add class invalid
                            z[i].className += " invalid-box";
                        }
                        

                        console.log(z[i].classList)
                        // Change valid to false
                        valid = false;
                        
                    }

                    if (z[i].value != "") {
                        z[i].classList.remove('invalid-box')

                    }
                }

                return valid;
            }


        })

    })

    $(document).ready(function () {
        $('.item').removeClass('active')
        $('.blocks-item').addClass('active')
    })

    $(document).ready(function () {
        $('#preset-btn').on('click', function () {
            $('#custom').fadeOut(300).slideUp().delay(300);
            $('#preset').delay(300).fadeIn(300).slideDown();
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            
        })
        $('#custom-btn').on('click', function () {
            $('#preset').fadeOut(300).slideUp().delay(300);
            $('#custom').delay(300).fadeIn(300).slideDown();
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
           

        })
    })

    $(document).ready(function () {
        
        $('.bless').on('click', function() {
            $('#delete').unbind();
            

            current_bless = $(this)
            let block_data = undefined
            block_data = {bless_id : $(this).attr('bless-value')};
            let json_data = JSON.stringify(block_data)

            console.log(block_data)

            if ($(this).hasClass('custom_bless')) {
                $("#delete").show()
            } else {
                $("#delete").hide()
            }
            
            $.ajax({
                url : '/_load_bless_settings',
                type : 'post',
                contentType : "application/json",

                dataType : 'json',
                data : json_data,
                success : function(data) {
                    // load all bless data into html
                    $('#title').html(data.name)
                    $('#heb').html(data.hebrew)
                    $('#eng').html(data.english)
                    $('#eng-heb').html(data.transliteration)
                    $('#meaning').html(data.meaning)
                    
                }
            })

            $('#delete').on('click', function() {
                if (current_bless.hasClass('custom_bless')) {
                $.ajax({
                    url : '/_delete_bless',
                    type : 'post',
                    contentType : "application/json",

                    dataType : 'json',
                    data : json_data,
                    success : function(data) {
                        console.log('deleted ' + data.id)
                        current_bless.slideUp()
                    }
                    
                })
                }
            })
        })
        
    })
</script>
{% endblock %}